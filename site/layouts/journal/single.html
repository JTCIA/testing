{{ define "main" }}
<div id="journal-gate" style="display:none">
  <div style="max-width:400px;margin:5rem auto;text-align:center;padding:2rem;border:1.5px solid #FCD34D;border-radius:12px;background:#FFFBEB;">
    <div class="journal-private-badge" style="justify-content:center;margin-bottom:1.5rem;">
      &#128274; PRIVATE — Personal Journal
    </div>
    <p style="font-size:0.9rem;color:#78350F;margin-bottom:1.5rem;">
      This section is not public. Enter the journal passphrase to continue.
    </p>
    <form id="journal-auth-form" onsubmit="return checkJournalPassword(event)">
      <input
        type="password"
        id="journal-password"
        placeholder="Passphrase"
        autocomplete="current-password"
        style="width:100%;padding:0.6rem 0.9rem;border:1.5px solid #FCD34D;border-radius:6px;font-size:0.95rem;margin-bottom:0.75rem;box-sizing:border-box;"
      >
      <button type="submit"
        style="width:100%;padding:0.6rem;background:#006D77;color:#fff;border:none;border-radius:6px;font-size:0.9rem;font-weight:600;cursor:pointer;">
        Enter Journal
      </button>
    </form>
    <p id="journal-error" style="display:none;color:#DC2626;font-size:0.8rem;margin-top:0.5rem;">
      Incorrect passphrase.
    </p>
  </div>
</div>

<div id="journal-content" style="display:none">
  <div class="journal-private-notice">
    <strong>&#128274; Private — Personal Journal</strong>
    This section is not public and is excluded from search engines.
    <a href="/journal/" style="color:#92400E;text-decoration:underline;">← All entries</a>
  </div>

  <article class="prose dark:prose-invert max-w-prose">
    <h1>{{ .Title }}</h1>
    <p class="text-sm text-neutral-400 mb-6">
      {{ .Date.Format "Monday, January 2, 2006" }}
      {{ with .Params.tags }}
        &nbsp;·&nbsp;
        {{ range . }}<span class="aa-reading-item__tag">{{ . }}</span> {{ end }}
      {{ end }}
    </p>
    {{ .Content }}
  </article>

  <div class="journal-publish-bar">
    <button class="journal-publish-btn" id="publish-btn">↑ Publish to Blog</button>
  </div>
</div>

{{/* Publish-to-Blog Modal */}}
<div id="publish-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;">
  <div id="publish-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);"></div>
  <div class="publish-modal__box">
    <div class="publish-modal__header">
      <h3 class="publish-modal__title">Publish to Blog</h3>
      <button class="publish-modal__close" id="publish-close">✕</button>
    </div>
    <p class="publish-modal__hint">
      Copy this, save as <code>content/articles/{{ .Date.Format "2006-01-02" }}-{{ .File.ContentBaseName }}.md</code>, then commit and push.
    </p>
    <pre class="publish-modal__pre" id="publish-content">---
title: "{{ .Title }}"
date: {{ .Date.Format "2006-01-02" }}
draft: false
description: ""
summary: ""
tags: {{ .Params.tags | jsonify }}
---

{{ .RawContent }}</pre>
    <div class="publish-modal__actions">
      <button class="publish-modal__copy" id="publish-copy">Copy to Clipboard</button>
      <span class="publish-modal__copied" id="publish-copied" style="display:none;">Copied!</span>
    </div>
  </div>
</div>

<script>
(function() {
  var modal = document.getElementById('publish-modal');
  document.getElementById('publish-btn').addEventListener('click', function() {
    modal.style.display = 'block';
  });
  document.getElementById('publish-close').addEventListener('click', function() {
    modal.style.display = 'none';
  });
  document.getElementById('publish-overlay').addEventListener('click', function() {
    modal.style.display = 'none';
  });
  document.getElementById('publish-copy').addEventListener('click', function() {
    var text = document.getElementById('publish-content').textContent;
    navigator.clipboard.writeText(text).then(function() {
      var copied = document.getElementById('publish-copied');
      copied.style.display = 'inline';
      setTimeout(function() { copied.style.display = 'none'; }, 2000);
    });
  });
})();
</script>

<script>
(function() {
  var SESSION_KEY = 'journal_auth';

  function checkSession() {
    return sessionStorage.getItem(SESSION_KEY) === 'granted';
  }

  function showContent() {
    document.getElementById('journal-gate').style.display = 'none';
    document.getElementById('journal-content').style.display = 'block';
    sessionStorage.setItem(SESSION_KEY, 'granted');
  }

  function showGate() {
    document.getElementById('journal-gate').style.display = 'block';
    document.getElementById('journal-content').style.display = 'none';
  }

  window.checkJournalPassword = function(e) {
    e.preventDefault();
    var pw = document.getElementById('journal-password').value;
    var stored = localStorage.getItem('journal_pw_hash');
    if (pw && (pw === window.__JOURNAL_PW__ || (stored && btoa(pw) === stored))) {
      showContent();
    } else {
      document.getElementById('journal-error').style.display = 'block';
    }
    return false;
  };

  // Cloudflare Access handles auth in production; always show content.
  showContent();
})();
</script>
{{ end }}
